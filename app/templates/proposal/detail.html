{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="breadcrumb-holder">
        <div class="container-fluid">
          <ul class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'app_proposals_list' %}">Proposals</a></li>
            <li class="breadcrumb-item active">{{ object.pid }}</li>
          </ul>
        </div>
      </div>
<section>
        <div class="container-fluid">
          <!-- Page Header-->
          <header> 
            <h1 class="h3 display">Details of proposal {{ object.pid }}</h1>
          </header>
<table class="table table-hover">
<tr><td>Proposal name</td><td><b>{{ object.name }}</b></td></tr>
<tr><td>Created</td><td>{{ object.created }}</td></tr>
<tr><td>Last updated</td><td>{{ object.last_updated }}</td></tr>
<tr><td>Status</td><td>{{ object.get_last_status_display }}</td></tr>
<tr><td>Abstract</td><td>{{ object.abstract }}</td></tr>
<tr><td>Scientific background</td><td>{% if object.scientific_bg %}<a href="{{ object.scientific_bg.url }}" target="_blank">{{ object.scientific_bg.name }}</a>{% else %}<b class="text-danger">missing</b>{% endif %}</td></tr>
<tr><td>Proposer</td><td>{{ object.proposer }}</td></tr>
<tr><td>Student</td><td>{% if object.student %}Yes, supervisor {{object.supervisor}}{% else %}No{% endif %}</td></tr>
<tr><td>Local Contact</td><td>{{ object.local_contact }}</td></tr>
<tr><td>Experimental team</td><td>{% for p in object.coproposers.all %}{{ p.name }}{%if not forloop.last%}, {%endif%}{% endfor %}</td></tr>
</table>
<p>
    {% if object.last_status == "P" %}
        Proposal is in preparation.
        {% if object.proposer == user %}
            You can still edit it as you want. It will not be reviewed, until you click <b>Submit Proposal</b>.
        {% else %}
            Proposer need to submit it in order to be reviewed.
        {% endif %}
        
    {% elif object.last_status == "S" %}
        Proposal is submitted, wait for evaluation.
    {% elif object.last_status in "U,T,W,R,D" %}
        Proposal is in review process, wait for evaluation.
    {% elif object.last_status == "A" %}
        Proposal is accepted, you can measure!
    {% elif object.last_status == "F" %}
        Proposal is finished, time to publish your research!
    {% elif object.last_status == "X" %}
        Proposal is rejected, sorry.
    {% endif %}
</p>
    {% if perms.app.approve_director and object.last_status == "D" %}
            <a class="btn btn-primary" href="/proposals/changestatus/{{object.slug}}/A/">Approve Proposal</a>
            <a class="btn btn-danger" href="/proposals/changestatus/{{object.slug}}/X/">Reject Proposal</a>
    {% endif %}
    {% if perms.app.change_status and object.last_status == "S" %}
            <a class="btn btn-primary" href="/proposals/changestatus/{{object.slug}}/U/">Takeover Proposal</a>
    {% endif %}
    {% if perms.app.change_status and object.last_status == "U" %}
            <a class="btn btn-primary" href="/proposals/changestatus/{{object.slug}}/T/">Pass to local contact</a>
            <a class="btn btn-danger" href="/proposals/changestatus/{{object.slug}}/P/">Return to user</a>
    {% endif %}
    {% if perms.app.approve_technical and object.last_status == "T" and object.local_contact.uid == user %}
            <a class="btn btn-primary" href="/proposals/changestatus/{{object.slug}}/W/">Submit technical comments</a>
            <a class="btn btn-secondary" href="{{object.get_update_url}}">Change local contact</a> 
    {% endif %}
    {% if object.proposer == user and object.last_status == "P" %}
       <a class="btn btn-secondary" href="{{object.get_update_url}}">Edit Proposal</a> 
       {% if object.last_status == "P" %}<a class="btn btn-primary" href="/proposals/changestatus/{{object.slug}}/S/">Submit Proposal</a>
       <a class="btn btn-danger" href="/proposals/delete/{{object.slug}}/">Delete Proposal</a> {% endif %}
    {% endif %}
    {% if perms.app.change_status and object.last_status in "P,S,U" %}
       <a class="btn btn-secondary" href="{{object.get_update_url}}">Edit proposal type and/or local contact</a> 
    {% endif %}
    {% if object.proposer == user and object.last_status == "A" %}
       <a class="btn btn-secondary" href="{{object.get_update_url}}">Edit experimental team</a> 
    {% endif %}
    
        <header> 
            <h2 class="h3 display">Status history</h2>
        </header>
        <div class="table-responsive">
        <table class="table table-striped table-sm table-hover">
            <thead>
                <tr>
                    <th>Status</th>
                    <th>Date</th>
                    <th>Remark</th>
                    {% if perms.app.see_hidden_remarks %}
                    <th>Hidden Remark</th>
                    <th>User</th>
                    {% endif %}
                </tr>
            </thead>
        {% for s in status_history %}
            <tr>
                <th scope="row">{{ s.get_status_display }}</th>
                <td>{{ s.date }}</td>
                <td>{{ s.remark }}</td>
                {% if perms.app.see_hidden_remarks %}
                <td>{{ s.hiddenremark }}</td>
                <td>{{ s.user }}</td>
                {% endif %}
            </tr>
        {% endfor %}
            </table>
            </div>
            </div>
    </section>
{% endblock %}
